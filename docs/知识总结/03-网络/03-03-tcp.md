# TCP

## TCP 与 UDP 的区别

|     |     TCP      |      UDP       |
| --- | :----------: | :------------: |
|     |   面向连接   |     无连接     |
|     |  面向字节流  |   面向数据报   |
|     |    有状态    |     无状态     |
|     | 保证可靠交付 | 不保证可靠交付 |
|     | 具备拥塞控制 | 不具备拥塞控制 |
|     |  点对点传播  |   广播、多播   |
|     |     有序     |      无序      |

## TCP 的握手

### 三次握手：建立连接

参与的主题是**客户端**和**服务器**

![img](https://tva1.sinaimg.cn/large/008eGmZEgy1gn5oyof4jdj30ii0bugml.jpg)

#### SYN 报文与 ACK 报文

##### SYN 报文

起**标识作用**的家伙

1. 当 **SYN=1** 而 **ACK=0** 时，表明这是一个**连接请求报文**。
2. 对方若同意建立连接，则应在**响应报文**中使 **SYN=1** 和 **ACK=1**。

因此, **SYN 置 1 就表示这是一个连接请求或连接接受报文**。

##### ACK 报文

TCP 协议规定，只有 **ACK=1** 时有效，也规定**连接建立后所有发送的报文的 ACK 必须为 1**。

#### 流程

1. **由客户端发出请求连接**，报文情况是： **SYN=1**，**ACK=0**，**seq=x**。按照规定，SYN=1 时不能携带数据，但要消耗一个序号，所以和 SYN 一起抵达战场的还有一个**记录序号的 seq，其值为 x**。
2. 然后**服务端进行回复确认**，报文内容是：**SYN=1**，**ACK=1**，同时还有**服务端为自己初始化的序号** **seq=y**, 以及**确认号 ack=x+1**
3. 再然后**客户端再进行一次确认**，这一步用不到 SYN 了，报文内容是：**ACK=1**, **seq=x+1**, **ack=y+1**。

### 四次挥手：断开链接

参与的主体依然是**客户端**和**服务器**

![img](https://tva1.sinaimg.cn/large/008eGmZEgy1gn5oyjihmhj30ii0bugml.jpg)

#### FIN 报文

新的报文类型就是 **FIN 报文**，它用来**释放一个连接**。 FIN=1 时，就表示此报文段的发送方的数据已经发送完毕，请求释放运输连接。

#### 流程

1. 在**客户端断开链接**的时候，就会向服务端抛出一个 **FIN=1** 报文。当然，一起过去的还有序列号 **seq=x**
2. **服务器接收到断开报文**，痛不欲生，但还是接受了现实，回复了一个 **ACK=1** 的标识**以示确认**。当然，一起过去的还有**确认**码 **ack=x+1**，以及它自己的**序列号** **seq=y**
3. **服务器确认发送完成**之后，向客户端抛出一个 **FIN=1** 报文，请求结束关系。当然啦，一起过去的还有**确认标识 ACK=1**、**确认码 ack=x+1**，以及自己的**新序列号 seq=z**
4. **客户端收到了服务端的断开请求**，向服务端抛出一个 **ACK=1** 的报文。当然啦，一起过去的还有确认码 **ack=z+1**，确认标识 **ACK=1**，以及自己的新序列号 **seq=x+1**
